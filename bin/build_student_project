#!/bin/sh

# Builds a student/team repository
#
# -R          don't resolve netid
# -c          clean build products from previous run

. "$(dirname "$0")/.CASS"
course_use find grade redact

process_args () {
    eval "$(getargs -Rc hw netid repo=)"
    netid=$(resolve_student ${flag_R:+-C} $netid)
    if [ -z "$repo" ]; then
        repo=$(find_team_repo $hw $netid)
    fi
    container=$(format_homework $hw)-$netid-build-$$

    # Preparation script can override this:
    export HOST_MAKE='make -rf .tester/Host_build_makefile'
    export TEST_HW=$hw
    export TEST_NETID=$netid
}

main () {
    process_args "$@"

    cd "$repo"
    lang=$(detect_language)

    rm -f build.log

    case $lang in
        (dssl2)
            touch build.log
            ;;
        (c|cxx)
            . $(find_homework_script $hw prepare) 2>build.log
            cat build.log >&2
            docker_start build "$container"
            ;;
    esac

    clean_build
    do_build
    test -f .success
}

guest () {
    docker exec $CURRENT_BUILD_CONTAINER "$@"
}

save_warnings () {
    sed -E '
        /^(.+):[0-9]+:[0-9]+: (warning|error): .*/! d
        s//\1/
    ' "$1" | sort | uniq > "$2"

    if [ -z "$(cat "$2")" ]; then
        rm -f "$2"
    fi
}

restore_warnings () {
    test -f "$1" || return 0

    ${lang}_expand "$1" | while read _line; do
        touch -c "$_line"
    done
}

do_build () {
    restore_warnings .warnings
    ${lang}_contract $HOST_MAKE | tee -a build.log
    save_warnings build.log .warnings
}

clean_build () {
    test -n "$flag_c" || return 0

    if [ -f CMakeLists.txt -a -d build ]; then
        guest cmake --build build --target clean
    else
        $HOST_MAKE clean
    fi
}

#########
main "$@"
#########
